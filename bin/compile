#!/bin/sh

indent() {
    sed 's/^/       /'
}

arrow() {
    sed 's/^/-----> /'
}

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3
WORKING_DIR=$(pwd)

echo "Installing Telegraf" | arrow

# influxdata-archive.key GPG fingerprint:
#   Primary key fingerprint: 24C9 75CB A61A 024E E1B6  3178 7C3D 5715 9FC2 F927
#   Subkey fingerprint:      9D53 9D90 D332 8DC7 D6C8  D3B9 D8FF 8E1F 7DF8 B07E

echo "Installing Influx GPG keys" | indent

wget -q https://repos.influxdata.com/influxdata-archive.key
gpg --show-keys --with-fingerprint --with-colons ./influxdata-archive.key 2>&1 | grep -q '^fpr:\+24C975CBA61A024EE1B631787C3D57159FC2F927:$' && cat influxdata-archive.key | gpg --dearmor | tee /etc/apt/trusted.gpg.d/influxdata-archive.gpg > /dev/null
echo 'deb [signed-by=/etc/apt/trusted.gpg.d/influxdata-archive.gpg] https://repos.influxdata.com/debian stable main' | tee /etc/apt/sources.list.d/influxdata.list

echo "Installing Influx package" | indent
apt-get update && apt-get install telegraf

TELEGRAF_CONF=${TELEGRAF_CONF:-telegraf.conf}

if [ ! -d $CACHE_DIR ]; then
    mkdir -p $CACHE_DIR
fi

influxdb_ssl_ca_cert="INFLUXDB_SSL_CA_CERT"
if [ -f $ENV_DIR/$influxdb_ssl_ca_cert ]; then
    echo "Found certificate for InfluxDB SSL CA" | indent
    mkdir -p $BUILD_DIR/.telegraf/etc
    cp $ENV_DIR/$influxdb_ssl_ca_cert $BUILD_DIR/.telegraf/etc/influxdb_ssl_ca_cert.pem
else
    echo "No InfluxDB certificate found" | indent
fi

if [ ! -d $BUILD_DIR/.profile.d ]; then
    mkdir -p "$BUILD_DIR/.profile.d"
fi

cat > $BUILD_DIR/.profile.d/001-heroku-buildpack-telegraf.sh << EOF
#!/bin/sh

pidfile=/tmp/telegraf.pid

# Start Telegraf from the with the configuration in /app/telegraf.conf (by default), redirect STDOUT to /dev/null (but STDERR should still come through the logs)
/sbin/start-stop-daemon --start --quiet --pidfile \$pidfile --exec telegraf -- -pidfile \$pidfile -config \$HOME/$TELEGRAF_CONF -quiet >/dev/null &

EOF

chmod +x $BUILD_DIR/.profile.d/001-heroku-buildpack-telegraf.sh


